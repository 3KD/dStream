# Ownerless P2P Live Streaming Protocol Specification

## Overview
This document defines the core data structures and message formats for the Ownerless P2P Live Streaming protocol. The system relies on cryptographic signatures for integrity and non-canonical endpoints for discovery and delivery.

## Data Structures

### Basic Types
- `ChannelPubKey`: Hex-encoded public key of the creator (Ed25519 or similar).
- `Signature`: Hex-encoded signature of the payload.
- `Hash`: SHA-256 hash, hex-encoded.

### 1. STREAM_ANNOUNCE
Broadcast by the broadcaster to announce a live stream.

```json
{
  "type": "STREAM_ANNOUNCE",
  "channel_pubkey": "<ChannelPubKey>",
  "stream_id": "<Hash(ChannelPubKey + start_timestamp + nonce)>",
  "start_time": 1700000000000,
  "ingest_hints": ["rtmp://ingest.example.com/live"],
  "origin_hints": ["https://origin.example.com/live/playlist.m3u8"],
  "tracker_hints": [
    "wss://tracker.openwebtorrent.com",
    "wss://tracker.files.fm:7073/announce"
  ],
  "renditions": [
    {
      "rendition_id": "1080p60",
      "codecs": "avc1.64002a,mp4a.40.2",
      "bandwidth_hint": 6000000,
      "playlist_path_hint": "stream_1080p.m3u8"
    }
  ],
  "signature": "<Signature>"
}
```

### 2. MANIFEST_ROOT
Published periodically (per EpochWindow) to authenticate stream segments.

```json
{
  "type": "MANIFEST_ROOT",
  "channel_pubkey": "<ChannelPubKey>",
  "stream_id": "<stream_id>",
  "rendition_id": "1080p60",
  "epoch_start_time": 1700000010000,
  "epoch_duration": 10000,
  "segment_hashes": [
    {
      "seq": 0,
      "uri_or_path_hint": "segment_0.ts",
      "sha256_hex": "<Hash>",
      "byte_length": 1500000,
      "metadata": {
        "title": "My Stream",
        "escrow_amount": 0.01 // Optional: Custom stake amount
        // ...
      }
    },
    {
      "seq": 1,
      "uri_or_path_hint": "segment_1.ts",
      "sha256_hex": "<Hash>",
      "byte_length": 1520000
    }
  ],
  "init_segment_hash": "<Hash>", // Only if fMP4
  "prev_manifest_root_hash": "<Hash>",
  "signature": "<Signature>"
}
```

### 3. TIP_RECEIPT
Generated by the viewer's wallet/client upon successful transaction.

```json
{
  "type": "TIP_RECEIPT",
  "channel_pubkey": "<ChannelPubKey>",
  "tipper_pubkey": "<OptionalPubKey>",
  "chain_namespace": "eip155", // or 'solana', 'bip122', 'lightning'
  "asset": "ETH", // or Contract Address
  "amount": "0.01",
  "tx_ref": "<TxHash or InvoiceID>",
  "timestamp": 1700000050000,
  "memo": "Great stream!",
  "signature": "<Signature>"
}
```

## Integrity & Verification Rules

1.  **Stream Announcement**:
    *   Client must verify `signature` against `channel_pubkey`.
    *   Client treats `hints` as non-authoritative. Failover is mandatory.

2.  **Manifest Root**:
    *   Client must verify `signature` against `channel_pubkey`.
    *   Client must match `stream_id` to expected stream.
    *   Manifests provide the *authoritative* hash list for segments in that epoch.

3.  **Segment Verification**:
    *   Upon downloading a segment (via HTTP or P2P), client calculates SHA-256.
    *   Must match the `sha256_hex` entry in the verified `MANIFEST_ROOT`.
    *   **Mismatch Action**: Discard data, penalize peer (if P2P), try fallback.

## Swarm Signaling
- **Swarm ID**: Derived from `Hash(channel_pubkey + stream_id + rendition_id)`.
- **Protocol**: WebTorrent compatible (infoHash = Swarm ID).
- **Tracker Behavior**: Clients announce to all `tracker_hints` in parallel.

## 4. Privacy-Preserving Tipping Verification
To verify tips without compromising viewer privacy or requiring a public transaction log:

1.  **Unique Subaddress Pattern**:
    *   For each tip session, the broadcaster generates a unique **Monero Subaddress** (or Integrated Address).
    *   This address is ephemeral and mapped internally to the Viewer Session ID.
2.  **Verification Logic**:
    *   Broadcaster monitors the blockchain for *any* transaction hitting that unique subaddress.
    *   Upon detection (mempool or block), the tip is cryptographically linked to the specific viewer.
    *   **Zero-Knowledge Proof (Optional)**: Viewer can provide a View Key for just that transaction to prove ownership without the broadcaster monitoring a unique address per user.

## 5. Swarm Incentives & Leech Protection
To maintain swarm health and prevent free-riding ("leeching"):

1.  **Peer Classification**:
    *   **Verified Peers** (Signed by Trusted Keyring): **No Stake Required**.
    *   **Unverified Peers** (Anonymous/New): **Must Deposit Stake**.

2.  **Escrow Mechanism (The "Anti-Leech" Bond)**:
    *   **Join**: Unverified peer deposits fee (e.g., 0.01 XMR or Token) into Escrow Contract.
    *   **Exit**: Peer requests withdrawal. Funds returned after `CHALLENGE_WINDOW` (e.g., 60s) if no bans recorded.
    *   **Ban/Slash**:
        *   If peer downloads > 10MB without uploading (Ratio < 0.1), neighbors sign a "Leech Proof".
        *   If Consensus > 66% of neighbors flag peer, Stake is **Slashed** (burned or distributed to swarm).
        *   Peer is disconnected.

## 6. Trusted Keyring Discovery (Private/Curated Mesh)
To enable decentralized discovery without a central registry, clients maintain a local **Keyring** of trusted public keys.

1.  **Keyring Structure**: A simple JSON list of Ed25519 public keys (e.g., `["pubkey1", "pubkey2"]`).
2.  **Discovery Logic**:
    *   Client connects to a generic DHT or Gossip network.
    *   Client filters *all* incoming `STREAM_ANNOUNCE` messages.
    *   **Rule**: If `announce.pubkey` is NOT in `Keyring`, discard immediately.
    *   **Result**: The user only sees streams from creators they explicitly trust.
3.  **Bootstrapping**:
    *   Users exchange keys out-of-band (social media, QR codes).
    *   "Web of Trust" expansion (optional): Trust keys signed by your trusted keys.
