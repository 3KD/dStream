# dStream Streaming Infrastructure
# Supports both x86 and ARM (M-series Mac)

services:
  mediamtx:
    image: bluenviron/mediamtx:latest
    container_name: dStream_ingest
    ports:
      - "1940:1935" # RTMP Ingest
      - "1941:1936" # RTMPS Ingest (Secure)
      - "8880:8880" # HLS/HTTP Output
      - "8881:8881" # WebRTC/WHIP
      - "8181:8181/udp" # ICE/UDP (WebRTC)
    volumes:
      - ./mediamtx.yml:/mediamtx.yml
      - /tmp/dStream_hls:/hls
      - ./certs:/certs
    environment:
      - MTX_logLevel=info
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:9990/v3/paths/list" ]
      interval: 10s
      timeout: 5s
      retries: 3

  # Next.js Web Application
  web:
    build: ../../apps/web
    container_name: dStream_web
    ports:
      - "5656:5656"
    volumes:
      - ../../apps/web:/app
      - /app/node_modules
    depends_on:
      mediamtx:
        condition: service_started
    restart: unless-stopped

  # Manifest Signing Service - generates signed segment hashes
  manifest:
    build: ../../services/manifest
    container_name: dStream_manifest
    environment:
      - HLS_DIR=/hls
      - MANIFEST_PRIVATE_KEY=${MANIFEST_PRIVATE_KEY:-}
    volumes:
      - /tmp/dStream_hls:/hls
    depends_on:
      mediamtx:
        condition: service_started
    restart: unless-stopped

  # Registry service is optional - Nostr replaces it
  # Uncomment if you need legacy registry:
  # registry:
  #   build: ../../services/registry
  #   container_name: dStream_registry
  #   ports:
  #     - "3002:3002"

  # Local Nostr Relay for Dev/Testing
  relay:
    image: scsibug/nostr-rs-relay:latest
    container_name: dStream_relay
    ports:
      - "8081:8080"
    volumes:
      - relay_data:/usr/src/app/db
    restart: unless-stopped

  # Test stream generator (optional)
  ffsim:
    image: linuxserver/ffmpeg:latest
    container_name: dStream_ffsim
    depends_on:
      mediamtx:
        condition: service_healthy
    command: >
      -re -f lavfi -i testsrc=size=1280x720:rate=30 -f lavfi -i sine=frequency=440:beep_factor=4 -c:v libx264 -preset ultrafast -tune zerolatency -b:v 1000k -g 60 -keyint_min 60 -sc_threshold 0 -c:a aac -b:a 128k -f flv rtmp://mediamtx:1935/test
    restart: unless-stopped
    command: >
      -re -f lavfi -i testsrc=size=1280x720:rate=30 -f lavfi -i sine=frequency=440:beep_factor=4 -c:v libx264 -preset ultrafast -tune zerolatency -b:v 1000k -g 60 -keyint_min 60 -sc_threshold 0 -c:a aac -b:a 128k -f flv rtmp://mediamtx:1935/test
    restart: unless-stopped
    profiles:
      - test

  # Real Monero Wallet RPC (Connects to Remote Node)
  monero:
    image: ghcr.io/sethforprivacy/simple-monero-wallet-rpc:latest
    container_name: dStream_monero
    ports:
      - "18081:18081" # RPC Port
    environment:
      - MONERO_WALLET_RPC_PASSWORD=superuser
      - DAEMON_HOST=node.community.rino.io:18081
    restart: unless-stopped

volumes:
  hls_data:
  relay_data:
